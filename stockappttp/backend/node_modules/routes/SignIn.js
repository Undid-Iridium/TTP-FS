const router = require("express").Router();
var ObjectID = require('mongodb').ObjectID;//Gets mongodb id
var cryptoObj = require("Utilities/crypto");
function typeOf(obj) {
  return {}.toString.call(obj).split(' ')[1].slice(0, -1).toLowerCase();
}
//const passport = require('passport');
//require('../config/passport');
//LocalStrategy = require('passport-local').Strategy; //./database_route.js
//const Sequelize = require('sequelize');
//const jwebtoken = require('jsonwebtoken');
// const jwtSecret = require('../config/jwtConfig')
const cors = require('cors')
let globalVariable = { db: null };

function initAssessmentRoutes(options) {
    globalVariable = options;
}    

/*router.get(() => {
	res.status(404).send("Sorry, can't find that!");
	res.redirect('/404.html');
});*/


/*router.get('/', function(req, res) {
    res.send('GET handler for /database_route.');
});

router.post('/', function(req, res) {
    res.send('POST handler for /database_route.');
});*/

module.exports = {
    assessmentRoutes: router,
    initAssessmentRoutes,
};

router.route('/update/:id').post(function(req,res) {
    res.send("Updated " + req.params.id);
})

router.route('/addToDB').post(function(req, res) {
    let obj = req.body;
    console.log(obj);
    globalVariable.db.findOne({"Email" : obj.Email}, (err, item) => {
            if(!item){
                 cryptoObj.cryptPassword(obj.Password, function(err, hashed){
		            if(err){
		    	        console.log("failed to hash");
		    	        res.send({ 'error': "Could not hash. Try again in 2 minutes"});
		            }
		            else{
		                obj.Password = hashed;
                        globalVariable.db.insertOne(obj)
                        .then(todo => {
                            res.status(200).json({'obj': 'obj added successfully'});
                        })
                        .catch(err => {
                            res.status(400).send('adding new obj failed');
                        });
                    }
                 });
            }
            else{
                res.send({error : "Email already in use"});
            }
    });
});

router.get('/db', (req, res) => {
    console.log(req.query.email + req.query.password);
    //res.send(req.query.username);
    globalVariable.db.findOne({"Email" : req.query.email}, (err, item) => {
        if(!item){
            res.status(422).send({response : "No account for said email"});
            return;
        }
        cryptoObj.comparePassword(req.query.password, item.Password, function(err, match){
            if(match){
                res.status(200).send({ response : "true"});
            }
            else{
                res.status(422).send( { response : "false"});
            }
        });
    });
});

/*router.post('/addToDB', cors(),(req, res) => {
    res.status(200).json({ response : 'added to DB'});
});*/

router.delete('/removeFromDB', (req, res) => {
  res.send('removed from DB');
});




